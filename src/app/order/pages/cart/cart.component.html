
<div class="cart">
  <ng-container *ngIf="{
    cartList:   (cartStore$ | async)?.cartList,
    cartInfo:   (cartStore$ | async)?.cartInfo,
    wishList:   (cartStore$ | async)?.wishList
  } as syncedData">
  <div class="row">
    <ng-container *ngIf="lengthCheckForFree !== 0 || lengthCheckForPack !== 0">
      <h1 class="cart__title h1-bold">쇼핑백</h1>
    </ng-container>
    <ng-container *ngIf="lengthCheckForFree === 0 && lengthCheckForPack === 0">
      <h1 class="cart__title h1-bold">쇼핑백이 비었어요!</h1>
      <div class="cart__title--empty-description subtitle-1-regular u-color-dark-grey">마음에 드는 상품을 못찾으셨나요? Onpicks와 함께 다양한 아이템을 최적의 가격으로 쇼핑하세요!</div>
    </ng-container>

    <ng-container *ngIf="lengthCheckForFree !== 0" >
      <div class="cart__section--title subtitle-1-bold">무료배송 상품</div>

      <div class="cart__delivery-free">
        <div class="cart__delivery-free-middle">
          <span class="cart__delivery-free-icon">
            <span class="cart__delivery-free-font u-bold u-color-white">F</span>
          </span>
          <span class="cart__delivery-free-spot-list">
            <ng-container [ngSwitch]="locale">
              <span *ngSwitchCase="'ko'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.4rem' }">뉴저지·엘에이·조지아·오사카·홍콩</span>
              <span *ngSwitchCase="'en'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.8rem' }">뉴저지·엘에이·조지아·오사카·홍콩</span>
              <span *ngSwitchCase="'zh'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.8rem' }">뉴저지·엘에이·조지아·오사카·홍콩</span>
            </ng-container>
            <span class="subtitle-1-bold u-color-green">무료배송</span>
          </span>
          <span class="cart__delivery-free-total-count subtitle-2-regular u-color-dark-grey">
            총 결제금액 <span class="subtitle-2-bold u-color-black">{{syncedData?.cartInfo?.free?.subtotal | onpicksCurrency : 'KRW'}}</span>
          </span>
        </div>
      </div>

      <onpicks-button
        class="cart__delivery-free-purchase"
        [type]="'white'"
        [size]="'big'"
        [width]="'16.1rem'">무료배송 구매하기
      </onpicks-button>

      <table class="cart__free-table">
        <tr  *ngFor="let itemForFree of syncedData?.cartInfo?.free?.items; index as itemForFreeIndex">
          <td>
            <div class="cart__free-table--image">
              <img drLazyLoad src="{{itemForFree.thumbnail}}" alt="">
            </div>

            <div class="cart__free-table--info">
              <div class="cart__free-table--info-title subtitle-3-bold">{{itemForFree.brand}}</div>
              <div class="cart__free-table--info-name body-3-regular">{{itemForFree.title}}</div>
              <div class="cart__multi-table--info-option">
                <ng-container *ngFor="let option of objectKeys(itemForFree.attribute_values); index as optionIndex">
                      <span class="subtitle-3-regular u-color-grey">
                        {{option}} :
                      </span>
                  <span class="subtitle-3-regular u-color-grey">
                        {{itemForFree.attribute_values[option]}}
                      </span>
                  <span
                    *ngIf="objectKeys(itemForFree.attribute_values).length - 1 !== optionIndex"
                    class="cart__multi-table--info-option--spliter-margin subtitle-3-regular u-color-grey">·</span>
                </ng-container>
              </div>
              <div class="cart__free-table--info-price subtitle-2-bold">{{itemForFree.price | onpicksCurrency : 'KRW'}}</div>
            </div>
          </td>
          <td>
            <div class="cart__free-table--amount">
              <onpicks-list-active-button
                (addEvent)="addToCart(syncedData?.cartList[itemForFree.product]?.quantity, itemForFree.product, 'free')"
                (subtractEvent)="subtractFromCart(syncedData?.cartList[itemForFree.product]?.quantity, itemForFree.product, 'free')"
                [amount]="syncedData?.cartList[itemForFree.product]?.quantity"
                [isFixExtend]="true">
              </onpicks-list-active-button>
            </div>

            <div class="cart__free-table--add-to-wish">
              <a (click)="addToWishList(itemForFree.product, 'free')"
                class="subtitle-2-regular u-color-grey">
                다음에 구매하기
              </a>
            </div>
            <div class="cart__free-table--delete">
              <a
                (click)="subtractFromCart(1, itemForFree.product, 'free' )"
                class="subtitle-2-regular u-color-grey">
                삭제하기
              </a>
            </div>

            <!--<div class="cart__multi-table&#45;&#45;add-to-wish">-->
              <!--<a-->
                <!--(click)="addToWishList(itemChild.product, locationMap[item.location.slug].sequence )"-->
                <!--class="subtitle-2-regular u-color-grey">-->
                <!--다음에 구매하기-->
              <!--</a>-->
            <!--</div>-->
            <!--<div class="cart__multi-table&#45;&#45;delete subtitle-2-regular u-color-grey">-->
              <!--<a-->
                <!--(click)="subtractFromCart(1, itemChild.product, locationMap[item.location.slug].sequence )"-->
                <!--class="subtitle-2-regular u-color-grey">-->
                <!--삭제하기-->
              <!--</a>-->
            <!--</div>-->
          </td>
          <td>
            <div class="cart__free-table--delivery-info">
              <div class="cart__free-table--delivery-info-image">
                <img src="http://img.onpicks.com/cart__table--info-N.png" alt="">
              </div>

              <div class="cart__free-table--delivery-info-where subtitle-2-regular"><span class="u-bold">뉴저지</span>출고&nbsp;·&nbsp;</div>
              <div class="cart__free-table--delivery-info-price subtitle-2-bold">무료배송</div>
              <div class="cart__free-table--delivery-info-description subtitle-2-regular u-color-dark-grey">뉴저지 단독 배송 상품으로 개별 배송료가 발생합니다.</div>
            </div>
          </td>
        </tr>
      </table>
    </ng-container>
    <ng-container *ngIf="lengthCheckForPack !== 0" >
      <div class="cart__section--title subtitle-1-bold">묶음 배송 상품</div>
      <ng-container
        *ngFor="let item of syncedData?.cartInfo?.pack; index as packIndex">
        <ng-container *ngIf="item.items?.length !== 0">

          <div class="cart__delivery-multi">
            <div class="cart__delivery-multi-middle">
              <span class="cart__delivery-multi-icon subtitle-1-bold"
                [ngClass]=
                  "[
                    (locationMap[item.location.slug].nickname === 'la')  ? 'icon-la' : '',
                    (locationMap[item.location.slug].nickname === 'new')  ? 'icon-new' : '',
                    (locationMap[item.location.slug].nickname === 'osaka')  ? 'icon-osaka' : '',
                    (locationMap[item.location.slug].nickname === 'gorgia')  ? 'icon-gorgia' : '',
                    (locationMap[item.location.slug].nickname === 'hong')  ? 'icon-hong' : ''
                  ]">
              </span>
              <span class="cart__delivery-multi-spot-list">
                <ng-container [ngSwitch]="locale">
                  <span *ngSwitchCase="'ko'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.4rem' }">{{item.location.name}}</span>
                  <span *ngSwitchCase="'en'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.8rem' }">{{item.location.name}}</span>
                  <span *ngSwitchCase="'zh'" class="subtitle-1-bold" [ngStyle]="{ 'marginRight' : '0.8rem' }">{{item.location.name}}</span>
                </ng-container>
                <span class="subtitle-1-regular">묶음배송</span>
              </span>
              <span class="cart__delivery-multi-total-count">
                <span class="subtitle-2-regular u-color-dark-grey">총 결제금액</span>
                <span class="subtitle-2-bold">{{item.subtotal | onpicksCurrency: 'KRW'}}</span>
              </span>
            </div>
          </div>

          <div class="cart__delivery-multi-purchase">
            <div class="cart__delivery-multi-purchase--remain">
              <div *ngIf="((item.free_shipping_threshold - (item.subtotal - item.shipping_fee)) > 0)" class="cart__delivery-multi-purchase--remain-description subtitle-2-regular">{{item.location.name}} 무료배송까지 {{item.free_shipping_threshold - (item.subtotal - item.shipping_fee) | onpicksCurrency:'KRW'}} 남았습니다</div>
              <div *ngIf="!((item.free_shipping_threshold - (item.subtotal - item.shipping_fee)) > 0)"class="cart__delivery-multi-purchase--remain-description subtitle-2-bold">{{item.location.name}} 무료배송 조건이 충족되었습니다</div>
              <ui-progressive-bar [progressWidth]="
              ((((item.subtotal - item.shipping_fee) / item.free_shipping_threshold) * 100) > 100 ? 100 :  ((((item.subtotal - item.shipping_fee) / item.free_shipping_threshold) * 100))) + '%'"></ui-progressive-bar>
            </div>

            <onpicks-button
              (click)="setCheckoutList(item.items)"
              class="cart__delivery-multi-purchase--btn"
              [type]="'white'"
              [size]="'big'"
              [width]="'16.1rem'"
            >묶음배송 구매하기</onpicks-button>
          </div>
          <table class="cart__multi-table">
            <tr *ngFor="let itemChild of item.items; index as itemIndex">
              <td>
                <div class="cart__multi-table--image">
                  <img src="{{itemChild.thumbnail}}" alt="">
                </div>
                <div class="cart__multi-table--info">
                  <div class="cart__multi-table--info-title subtitle-3-bold">{{itemChild.brand}}</div>
                  <div class="cart__multi-table--info-name subtitle-3-regular">{{itemChild.title}}</div>
                  <div class="cart__multi-table--info-option">
                    <ng-container *ngFor="let option of objectKeys(itemChild.attribute_values); index as optionIndex">
                      <span class="subtitle-3-regular u-color-grey">
                        {{option}} :
                      </span>
                      <span class="subtitle-3-regular u-color-grey">
                        {{itemChild.attribute_values[option]}}
                      </span>
                      <span
                        *ngIf="objectKeys(itemChild.attribute_values).length - 1 !== optionIndex"
                        class="cart__multi-table--info-option--spliter-margin subtitle-3-regular u-color-grey">·</span>
                    </ng-container>
                  </div>
                  <div class="cart__multi-table--info-price subtitle-2-bold">{{itemChild.sale_price | onpicksCurrency: 'KRW'}}</div>


                </div>
              </td>
              <td>
                <div class="cart__multi-table--amount">
                  <onpicks-list-active-button
                    (addEvent)="addToCart(syncedData?.cartList[itemChild.product]?.quantity, itemChild.product, locationMap[item.location.slug].sequence)"
                    (subtractEvent)="subtractFromCart(syncedData?.cartList[itemChild.product]?.quantity, itemChild.product, locationMap[item.location.slug].sequence)"
                    [amount]="syncedData?.cartList[itemChild.product]?.quantity"
                    [isFixExtend]="true">
                  </onpicks-list-active-button>
                </div>

                <div class="cart__multi-table--add-to-wish">
                  <a
                    (click)="addToWishList(itemChild.product, locationMap[item.location.slug].sequence )"
                    class="subtitle-2-regular u-color-grey">
                    다음에 구매하기
                  </a>
                </div>
                <div class="cart__multi-table--delete subtitle-2-regular u-color-grey">
                  <a
                    (click)="subtractFromCart(1, itemChild.product, locationMap[item.location.slug].sequence )"
                    class="subtitle-2-regular u-color-grey">
                    삭제하기
                  </a>
                </div>
              </td>
              <td *ngIf="itemIndex === 0" [attr.rowspan]="item?.items.length">
                <div class="cart__multi-table--delivery-info">
                  <div class="cart__multi-table--delivery-info-price" [ngSwitch]="(item.subtotal - item.shipping_fee) < item.free_shipping_threshold">
                    <span class="subtitle-2-regular" *ngSwitchCase="true">{{item.shipping_fee | onpicksCurrency: 'KRW'}}</span>
                    <span class="subtitle-2-bold u-color-green" *ngSwitchDefault>무료</span>
                  </div>
                  <div class="cart__multi-table--delivery-info-description subtitle-2-regular u-color-dark-grey">뉴저지 단독 배송 상품 {{item.free_shipping_threshold | onpicksCurrency: 'KRW'}} 이상 주문시 무료 배송</div>
                </div>
              </td>
            </tr>
          </table>
        </ng-container>

      </ng-container>
    </ng-container>
    <onpicks-sort-box
      (click)="toggleWishList(f)"
      class="cart__load-purchase-thing"
      [fontSize]="'1.4rem'"
      [showBox]="false"
      [sortList]="[{ title : '다음에 구매할 물건 불러오기', value : 0 }]">
    </onpicks-sort-box>
    <div #f class="cart__wishlist">
      <div class="cart__wishlist--title h1-bold">다음에 구매하기</div>
      <ng-container *ngIf="syncedData?.wishList?.length === 0">
        <div class="subtitle-1-regular u-color-dark-grey">
          다음에 구매할 상품이 없습니다. 다음에 구매할 상품을 담아주세요!
        </div>
      </ng-container>
      <table class="cart__wishlist-table">
        <tr *ngFor="let item of syncedData?.wishList; index as i">
          <td>
            <div class="cart__wishlist-table--image">
              <img drLazyLoad src="{{item.thumbnail}}" alt="">
            </div>

            <div class="cart__wishlist-table--info">
              <div class="cart__wishlist-table--info-title subtitle-3-bold">{{item.brand}}</div>
              <div class="cart__wishlist-table--info-name subtitle-3-regular">{{item.title}}</div>
              <div class="cart__wishlist-table--info-price subtitle-2-bold">{{item.price | onpicksCurrency: 'KRW'}}</div>
            </div>
          </td>
          <td>
            <div class="cart__wishlist-table--delivery-info">
              <span
                class="cart__wishlist-table--delivery-info-image"
                [ngClass]=
                "[
                  (locationMap[item?.location.slug]?.nickname === 'la')  ? 'icon-small-la' : '',
                  (locationMap[item?.location.slug]?.nickname === 'new')  ? 'icon-small-new' : '',
                  (locationMap[item?.location.slug]?.nickname === 'osaka')  ? 'icon-small-osaka' : '',
                  (locationMap[item?.location.slug]?.nickname === 'gorgia')  ? 'icon-small-gorgia' : '',
                  (locationMap[item?.location.slug]?.nickname === 'hong')  ? 'icon-small-hong' : ''
                ]">
              </span>

              <div class="cart__wishlist-table--delivery-info-where subtitle-2-regular">
                <span class="u-bold">{{item.location.name}}</span>&nbsp;출고&nbsp;·</div>
              <div class="cart__wishlist-table--delivery-info-price subtitle-2-bold" *ngIf="item.ship_alone">&nbsp;무료배송</div>
              <div class="cart__wishlist-table--delivery-info-price subtitle-2-regular"
                   *ngIf="!item.ship_alone">묶음배송 · {{item.location.base_shipping_fee | onpicksCurrency:'KRW'}}</div>
              <div class="cart__wishlist-table--delivery-info-description subtitle-2-regular u-color-dark-grey">뉴저지 묶음배송 상품으로 {{item.location.free_shipping_threshold | onpicksCurrency: 'KRW'}} 이상 주문시 배송료 무료</div>
            </div>
          </td>
          <td>
            <button
              *ngIf="item.attributes.length !== 0"
              class="btn btn--white btn--small cart__wishlist-table--btn"
              [routerLink]="'/shops/p/' + item.product">옵션 선택하기</button>
            <button
              (click)="moveWishListToCart(1, item.product, item.ship_alone ? 'free' : locationMap[item?.location.slug]?.sequence, item.id, i)"
              *ngIf="item.attributes.length === 0"
              class="btn btn--white btn--small cart__wishlist-table--btn"
              >쇼핑백에 담기</button>
            <button
              class="btn btn--white btn--small cart__wishlist-table--btn"
              (click)="deleteWishList(item.id, i)">삭제하기</button>
          </td>
        </tr>
      </table>
    </div>


    <div class="cart__payment">
      <div class="cart__section--title h1-bold">결제금액</div>
      <table class="cart__payment-table">
        <tr class="subtitle-2-regular u-color-dark-grey">
          <td>총 상품금액</td>
          <td></td>
          <td>배송비</td>
          <td></td>
          <td>할인금액</td>
          <td></td>
          <td>총 결제금액</td>
        </tr>
        <tr class="h1-bold">
          <td>{{syncedData?.cartInfo?.total?.total_items | onpicksCurrency: 'KRW'}}</td>
          <td>+</td>
          <td [ngClass]="{ 'u-color-green' : syncedData?.cartInfo?.total?.total_shipping_fee == 0}">{{syncedData?.cartInfo?.total?.total_shipping_fee === 0 ? '무료' : (syncedData?.cartInfo?.total?.total_shipping_fee  | onpicksCurrency: 'KRW')}}</td>
          <td>-</td>
          <td>{{syncedData?.cartInfo?.total?.total_discounts | onpicksCurrency: 'KRW'}}</td>
          <td>=</td>
          <td>{{syncedData?.cartInfo?.total?.total_items + syncedData?.cartInfo?.total?.total_shipping_fee | onpicksCurrency : 'KRW'}}</td>
        </tr>
      </table>
    </div>
    <onpicks-button
      class="cart__btn--shopping"
      routerLink="/shops"
      [type]="'white'"
      [size]="'big'"
      [width]="'13.4rem'">계속 쇼핑하기
    </onpicks-button>
    <onpicks-button
      (click)="setCheckoutList(denormalizr(cartStore.cartList))"
      class="cart__btn--shopping"
      [type]="'black'"
      [size]="'big'"
      [width]="'13.4rem'">전체 구매하기
    </onpicks-button>
    </div>
  </ng-container>

  <ui-mini-list [infoList]="weeklyBest$ | async" [setTitle]="'추천상품'"></ui-mini-list>
</div>

