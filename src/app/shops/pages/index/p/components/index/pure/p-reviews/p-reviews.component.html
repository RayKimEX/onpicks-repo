<ng-template #loading>
  loading stuff...
</ng-template>

<onpicks-modal
  class="modal"
  (exit)="isShowModal = false"
  [isShow]="isShowModal">

  <h1 class="modal__title h1-bold">신고사유를 선택해주세요.</h1>
  <div
    *ngFor="let key of objectKeys(reasonMap['ko'])"
    class="modal__item subtitle-2-regular">
    {{key}}
    <onpicks-check-box
      (boxEvent)="textReportReasonForModal = $event"
      class="modal__item--check-box"
      [value]="reasonMap['ko'][key]"
      [type]="'radio'">
    </onpicks-check-box>
  </div>
  <onpicks-button
    (click)="reportReview(productSlugForModal, reviewIndexForModal, textReportReasonForModal)"
    class="modal__btn"
    [width]="'10.1rem'"
    [size]="'big'"
    [type]="'black'">
    신고하기
  </onpicks-button>
</onpicks-modal>

<ng-container *ngLet="(reviews$ | async) as data;">
  <div class="p-reviews u-margin-bottom" *ngIf="data?.results?.length > 0">
    <!--async에대한 처리로 추가로 감싸줌-->

      <h1 class="p-reviews__title h1-bold">
        리뷰 {{data.results?.length}}개
      </h1>
      <ui-star-rating
        [star-point]="data.extraInfo?.reviewAvgRating">
      </ui-star-rating>

      <div class="subtitle-1-regular u-color-dark-grey u-margin-bottom--small">
        별점 분포
      </div>
      <table class="p-reviews__table">
        <tr  *ngFor="let key of objectKeys(starMaxList);  index as i ">
          <td class="p-reviews__table--col subtitle-1-regular">
            <svg  width="14" height="14"  class="star--14">
              <path class="u-color-fill-black"  d="M10.76,8h0l1.47-1.12L13.69,5.8c.48-.36.39-.66-.2-.66H8.79L8.45,4.06h0L7.89,2.25,7.33.44c-.18-.59-.48-.59-.66,0L5.55,4.06h0L5.21,5.14H.51c-.59,0-.68.3-.2.66L1.77,6.92,3.24,8h0l.87.67-.89,2.88L2.66,13.4c-.19.59.06.78.54.41L7,10.91l2.34,1.78,1.46,1.12c.48.37.73.18.54-.41l-.56-1.81L9.89,8.71Z"/>
            </svg>
            <span class="p-reviews__table--point">{{5-i}}점</span>
          </td>
          <td class="p-reviews__table--col subtitle-1-regular">
            <div class="p-reviews__table--line">
              <div class="p-reviews__table--line-current"
                   drAnimateOnScroll
                   [animateObject]="{ property: 'width', value: (starMaxList[key] / data.results?.length) * 100 + '%' }"
                   [timing-function]="'cubic-bezier(0.075, 0.82, 0.165, 1)'"
                   [duration]="'1s'">
              </div>
            </div>
          </td>
          <td class="p-reviews__table--col subtitle-1-regular">{{(starMaxList[key] / data.results?.length) * 100}}%</td>
        </tr>
      </table>

      <hr id="forReview" #hrLineList>

      <div class="p-reviews__small-header">
        <div class="subtitle-1-bold u-inline-block">구매자들의 {{data.results.length}}개 리뷰</div>
        <onpicks-sort-box
          [selectedElement]="selectedElement"
          (changeEvent)="reviewSorting($event)"
          [sortList]="reviewSortList">
        </onpicks-sort-box>
      </div>

      <div *ngFor="let item of data.results; index as i">
        <figure class="p-reviews__figure u-margin-bottom--small">
          <span class="p-reviews__figure--outer">
            <img
              [drLazyLoad]="{ method : 'animation' }"
              src="{{data.list[item].author.avatar}}" alt="Person on a tour" class="story__img">
          </span>
          <div class="p-reviews__figure--caption">
            <figcaption
              class="p-reviews__figure subtitle-1-bold">{{data.list[item].author.nickname}}</figcaption>
            <ui-star-rating
              [star-point]="data.list[item].rating"></ui-star-rating>
            <span
              class="p-reviews__figure--caption-date subtitle-2-regular u-color-dark-grey">{{data.list[item].modified | timeAgo}}</span>
          </div>
        </figure>
        <div
          class="subtitle-1-regular u-color-grey">Size: X-Large · Color: Aqua · {{data.list[item].helpful_count}}명이 추천하였습니다 </div>

        <div
          class="p-reviews__content-outer">

          <!--array length가 0이거나, pictures[0]이 ''인경우 : 이미지가 없는경우-->
          <p
            class="p-reviews__content body-1-regular"
             [ngStyle]="{'width' : data.list[item].pictures.length === 0 || data.list[item].pictures[0] === '' ? 'auto' : '52.8rem'}">
            {{data.list[item].text}}
          </p>

          <!--array length이 0이 아니면, pictures[0]도 ''가 아니어야한다. : 이미지가 있는 경우-->
          <span
            class="p-reviews__image"
                *ngIf="data.list[item].pictures.length !== 0 && data.list[item].pictures[0] !== ''">
            <img
              [drLazyLoad]="{method:'animation'}"
              src="{{data.list[item].pictures[0]}}"
              alt="">
          </span>
        </div>

        <div class="p-reviews__option">
          <a>
            <svg
              width="18"
              height="20"
              viewBox="0 0 18 20">
              <path
                [ngClass]="{ 'p-reviews__option--thumbs-up-active' : data.list[item].mark_as_voted}"
                fill="#767676"
                fill-rule="evenodd"
                d="M15.969 10.309c-.004.027-.003.058-.009.085v.004l-.002.009L15 16a1.985 1.985 0 0 1-1 1.724 1.985 1.985 0 0 1-.982.276H6V8a2.995 2.995 0 0 0 2.916-2.322C8.967 5.459 9 5.234 9 5V3a1 1 0 0 1 1-1 2 2 0 0 1 2 2v3a1 1 0 0 0 1 1h1c.114 0 .224.016.332.034.021.004.04.002.061.005l.001.001a1.978 1.978 0 0 1 .728.305c.033.023.059.05.089.073.072.056.145.11.208.174.026.026.045.057.07.084.061.069.123.138.174.215.012.017.019.037.03.055.057.091.111.184.153.284l.006.02a2.008 2.008 0 0 1 .148.746c0 .103-.014.208-.031.313M2.5 17.847A.984.984 0 0 1 2 17V9c0-.366.206-.672.5-.846A.972.972 0 0 1 3 8h1v10H3a.97.97 0 0 1-.5-.153m15.427-8.599a4.04 4.04 0 0 0-.168-.61l-.011-.04-.059-.143a3.688 3.688 0 0 0-.259-.502 1.642 1.642 0 0 0-.106-.176 3.608 3.608 0 0 0-.307-.393 2.657 2.657 0 0 0-.178-.201 3.504 3.504 0 0 0-.372-.322 2.363 2.363 0 0 0-.221-.17 3.994 3.994 0 0 0-1.461-.612l-.137-.028-.083-.006A3.873 3.873 0 0 0 14 6V4c0-2.206-1.794-4-4-4-1.654 0-3 1.346-3 3v2c0 .059-.01.135-.032.227A.99.99 0 0 1 6 6H3c-.524 0-1.036.146-1.52.434A2.967 2.967 0 0 0 0 9v8c0 1.058.553 2.017 1.48 2.567.484.288.996.433 1.52.433h10.002a4.02 4.02 0 0 0 2.002-.546 4.003 4.003 0 0 0 1.991-3.254l.935-5.455.019-.113.003-.049.004-.038a3.665 3.665 0 0 0-.029-1.297"/>
            </svg>

            <span
              (click)="toggleVoteReviews(data.list[item].product, data.list[item].id, data.list[item].mark_as_voted)"
              [ngClass]="{ 'p-reviews__option--active' : data.list[item].mark_as_voted}"
              class="p-reviews__option--feature action-1-medium">
              {{data.list[item].mark_as_voted ? '추천함' : '추천하기'}}
            </span>
          </a>
          <a>
            <img src="http://img.onpicks.com/comments-icon.jpg" alt="">
            <span
              class="p-reviews__option--feature action-1-medium"
              (click)="commentReview('/shops/p/' + data.list[item].product + '/reviews/' + data.list[item].id)"
            >댓글 달기</span>
          </a>
          <a>
            <img src="http://img.onpicks.com/share-icon.jpg" alt="">
            <span
              (click)="shareReview('/shops/p/' + data.list[item].product + '/reviews/' + data.list[item].id)"
              class="p-reviews__option--feature action-1-medium">
              공유 하기
            </span>
          </a>
          <a>
            <span
              (click)="
                isShowModal = true;
                reviewIndexForModal = data.list[item].id;
                productSlugForModal = data.list[item].product"
              class="p-reviews__option--report subtitle-1-regular u-color-grey">
              신고하기
            </span>
          </a>
          <hr #hrLineList>
        </div>
      </div>
    <div class="p-reviews__pagination--outer">
      <div class="p-reviews__pagination">
        <ul *ngIf="currentPage >= 1">
          <li *ngIf="currentPage !== 1">
            <div (click)="paginate(currentPage - 1)">
              <svg width="9" height="14" viewBox="0 0 9 14">
                <path fill="none" fill-rule="evenodd" stroke="#767676" stroke-width="2" d="M8 1L2 7.05 8 13"/>
              </svg>
            </div>
          </li>

          <span *ngIf="currentPage <= 4">
            <!--5이하일 경우엔 가변 처리 없이, 무조건 5까지 다 보여줌-->
            <span *ngIf="totalPageArray.length <= 7">
              <li *ngFor="let number of totalPageArray;  index as i;" >
                <div (click)="paginate(i + 1)" [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === (1 + i)}">{{i + 1}}</div>
              </li>
            </span>
            <span *ngIf="totalPageArray.length >= 8">
              <li *ngFor="let number of numberArray(5)  index as i;" >
                <div (click)="paginate(i+ 1)" [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === (1 + i)}">{{i+ 1}}</div>
              </li>
              <li>
                <div class="p-reviews__pagination--finite-num">...</div>
              </li>
              <li>
                <div (click)="paginate( totalPageArray.length )" [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === totalPageArray.length }">{{totalPageArray.length }}</div>
              </li>
            </span>
          </span>

          <span *ngIf="currentPage >= 5">
            <!--currentPage가 5이상일 경우에도 가변 처리 없이, 무조건 7까지는 다 보여줌-->
            <span *ngIf="totalPageArray.length <= 7">
              <li *ngFor="let number of totalPageArray;  index as i;" >
                <div (click)="paginate(i + 1)" [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === (1 + i)}">{{i + 1}}</div>
              </li>
            </span>
            <!--currentPage가 5이상이고 totalPage가 8이상일 경우엔 가변처리를 뿌려줌-->
            <span *ngIf="totalPageArray.length >= 8">
              <li>
                <div (click)="paginate( 1 )" >1</div>
              </li>
              <li>
                <div class="p-reviews__pagination--finite-num">...</div>
              </li>

              <!--currentPage가 5이상이고 totalPage - currentPage가 4보다 크면 가변 처리 되는 조건 ( 거의 대부분의 조건에 해당 )-->
              <span *ngIf="(totalPageArray.length - currentPage) >= 4">
                <li>
                 <div (click)="paginate( currentPage - 1 )">{{currentPage - 1}}</div>
                </li>
                <li>
                 <div (click)="paginate( currentPage )" class="p-reviews__pagination--number-bold">{{currentPage}}</div>
                </li>
                <li>
                 <div (click)="paginate( currentPage + 1)">{{currentPage + 1}}</div>
                </li>
                <li>
                  <div class="p-reviews__pagination--finite-num">...</div>
                </li>
                <li>
                  <div (click)="paginate( totalPageArray.length )" [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === totalPageArray.length }">{{totalPageArray.length }}</div>
                </li>
              </span>

              <!--totalPage - currentPage가 3이하면 특수 조건 발동 -->
              <span *ngIf="(totalPageArray.length - currentPage) <= 3">
                <!-- 특수 조건에서 for 갯수는,totalPage - currentPage + 2가됨,
                 마지막 page일 경우 ( currentPage === length )에는, 1을 더 추가해서, 앞에 하나 더 나오게 함  -->
                <!-- TODO : 아래의 소스는 가독성이 떨어지므로 한번 수정 필요  -->
                <span *ngFor="let item of numberArray(totalPageArray.length - currentPage + 2 + (  currentPage === totalPageArray.length ? 1 : 0));  index as i;">
                  <li>
                    <!-- +1의 의미는 현재 페이지에서 앞에 li를 하나 더 나오게 한다는 의미-->
                    <div
                      (click)="paginate( totalPageArray.length - ( (totalPageArray.length - currentPage + 1 + ( currentPage === totalPageArray.length ? 1 : 0)) - i ) )"
                      [ngClass]="{'p-reviews__pagination--number-bold' : currentPage === (totalPageArray.length - ( (totalPageArray.length - currentPage + 1 + ( currentPage === totalPageArray.length ? 1 : 0))- i)) }">
                      {{totalPageArray.length - ( (totalPageArray.length - currentPage + 1 + ( currentPage === totalPageArray.length ? 1 : 0))- i) }}
                    </div>
                  </li>
                </span>
              </span>
            </span>
          </span>
          <li *ngIf="currentPage !== totalPageArray.length && totalPageArray.length !== 0">
            <div (click)="paginate(currentPage + 1)">
              <svg width="9" height="14" viewBox="0 0 9 14">
                <path fill="none" fill-rule="evenodd" stroke="#767676" stroke-width="2" d="M1 13l6-6.05L1 1"/>
              </svg>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</ng-container>

