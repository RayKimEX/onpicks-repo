
<!--가장 마지막에 로딩하는것을 loading으로 잡아줌.-->
<!--여기서는 댓글이 가장 마지막에 다시 로딩함. 그래서 댓글 기준으로 loading바를 받음-->
<ng-template class="hello" #loading>
  Loading stuff...
</ng-template>

<ng-template class="hello" #imaegLoading>
  Loading stuff...
</ng-template>




<onpicks-modal
  class="modal"
  (exit)="exitShowModal()"
  [isShow]="isShowModal">

  <h1 class="modal__title h1-bold">신고사유를 선택해주세요.</h1>
  <div
    *ngFor="let key of objectKeys(reasonMap['ko'])"
    class="modal__item subtitle-2-regular">
    {{key}}
    <onpicks-check-box
      (boxEvent)="textReportReasonForModal = $event"
      class="modal__item--check-box"
      [value]="reasonMap['ko'][key]"
      [type]="'radio'">
    </onpicks-check-box>
  </div>
  <onpicks-button
    (click)="reportReview(productSlugForModal, reviewIndexForModal, textReportReasonForModal)"
    class="modal__btn"
    [width]="'10.1rem'"
    [size]="'big'"
    [type]="'black'">
    신고하기
  </onpicks-button>
</onpicks-modal>



<ng-container *ngIf="
{
  review : (currentData$ | async)?.list[reviewsId],
  results : (currentData$ | async)?.results,
  pictures : (currentData$ | async)?.list[reviewsId]?.pictures
} as data else loading">

<!--async 쓰고싶은데, 동적으로 현재 데이터가 있는지 없는지 판단해서, 넣고 안놓고는 어떻게하지? async유지하면서? -->

<!--nested 한 값은, ?을 연속으로 넣어서 null체크해줌-->
<!--1056px로 넣은 이유는 가독성을 위해 dumb값을 넣은것임.-->
<div
  #communicateBox

  [ngStyle]="{ width : data.pictures?.length === 0 || (data.pictures ? data.pictures[0] : '1056px') === '' ? '660px' : '1056px'}"
  class="communicate-box">
  <!--[ngStyle]="{ width : data.review['pictures'].length === 0 ? ''}"-->
    <div *ngIf="isViewImage && data.pictures as asPictures;"
         class="communicate-box__image">
      <img
        [drLazyLoad]="{ method : 'pure-transition'}" src="{{data.pictures[0]}}" alt="">
    </div>
    <div
      #communicateBoxOnly
      [ngStyle]="{ width : data.pictures?.length === 0 || (data.pictures ? data.pictures[0] : '1056px') === ''  ? '660px' : '408px'}"
      class="communicate-box-only">
      <div class="communicate-box-only__inner">

        <div class="communicate-box-only__figure">
          <figure>
            <span class="communicate-box-only__figure--image-outer">
              <img drLazyLoad src="{{data.review?.author?.avatar}}" alt="Person on a tour" class="story__img">
            </span>
            <figcaption class="communicate-box-only__caption subtitle-1-bold">{{data.review?.author?.nickname}}</figcaption>

            <ui-star-rating [star-point]="data.review?.rating"></ui-star-rating>
            <span class="communicate-box-only__figure--created-date subtitle-2-regular u-color-dark-grey">{{data.review?.modified | timeAgo}}</span>
          </figure>
          <div class="communicate-box-only__figure--option subtitle-1-regular u-color-grey">
            맛: 믹스베이 세트 : 1번세츠 ( 12팩 )
          </div>
        </div>
        <div #scrollOuter class="communicate-box-only__reviews">
          <div class="communicate-box-only__reviews--my-reviews body-1-regular">
            {{data.review?.text}}
          </div>
          <div class="communicate-box-only__reviews--other-reviews">
            <!--TODO : 해당 로직은, 이미 로딩한것은 로딩 안해도 되도록 변경해야함.-->
            <div *ngIf="data.review?.comments?.results as asComments; else loading">
              <div *ngFor="let item of asComments" class="communicate-box-only__reviews--other-reviews-item">
                <span class="subtitle-1-bold">{{item.author.nickname}}</span>
                <span class="body-1-regular">{{item.text}}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="communicate-box-only__feature">
          <a>
            <svg
              width="18"
              height="20"
              viewBox="0 0 18 20">
              <path
                [ngClass]="{ 'communicate-box-only__feature--thumbs-up-active' : data.review?.mark_as_voted}"
                fill="#767676"
                fill-rule="evenodd"
                d="M15.969 10.309c-.004.027-.003.058-.009.085v.004l-.002.009L15 16a1.985 1.985 0 0 1-1 1.724 1.985 1.985 0 0 1-.982.276H6V8a2.995 2.995 0 0 0 2.916-2.322C8.967 5.459 9 5.234 9 5V3a1 1 0 0 1 1-1 2 2 0 0 1 2 2v3a1 1 0 0 0 1 1h1c.114 0 .224.016.332.034.021.004.04.002.061.005l.001.001a1.978 1.978 0 0 1 .728.305c.033.023.059.05.089.073.072.056.145.11.208.174.026.026.045.057.07.084.061.069.123.138.174.215.012.017.019.037.03.055.057.091.111.184.153.284l.006.02a2.008 2.008 0 0 1 .148.746c0 .103-.014.208-.031.313M2.5 17.847A.984.984 0 0 1 2 17V9c0-.366.206-.672.5-.846A.972.972 0 0 1 3 8h1v10H3a.97.97 0 0 1-.5-.153m15.427-8.599a4.04 4.04 0 0 0-.168-.61l-.011-.04-.059-.143a3.688 3.688 0 0 0-.259-.502 1.642 1.642 0 0 0-.106-.176 3.608 3.608 0 0 0-.307-.393 2.657 2.657 0 0 0-.178-.201 3.504 3.504 0 0 0-.372-.322 2.363 2.363 0 0 0-.221-.17 3.994 3.994 0 0 0-1.461-.612l-.137-.028-.083-.006A3.873 3.873 0 0 0 14 6V4c0-2.206-1.794-4-4-4-1.654 0-3 1.346-3 3v2c0 .059-.01.135-.032.227A.99.99 0 0 1 6 6H3c-.524 0-1.036.146-1.52.434A2.967 2.967 0 0 0 0 9v8c0 1.058.553 2.017 1.48 2.567.484.288.996.433 1.52.433h10.002a4.02 4.02 0 0 0 2.002-.546 4.003 4.003 0 0 0 1.991-3.254l.935-5.455.019-.113.003-.049.004-.038a3.665 3.665 0 0 0-.029-1.297"/>
            </svg>
            <span
              (click)="toggleVoteReviews(data.review.product, data.review.id, data.review?.mark_as_voted)"
              [ngClass]="{ 'communicate-box-only__feature--recommend--active' : data.review?.mark_as_voted}"
              class="communicate-box-only__feature--recommend action-1-medium">
              {{data.review?.mark_as_voted ? '추천함' : '추천하기'}}
            </span>
          </a>
          <a>
            <img src="http://img.onpicks.com/share-icon.jpg" alt="">
            <span
              class="communicate-box-only__feature--item action-1-medium"
              (click)="shareReview()">
              공유하기
            </span>
          </a>
          <a>
            <span
              (click)="
                isShowModal = true;
                reviewIndexForModal = data.review.id;
                productSlugForModal = data.review.product;"
              class="communicate-box-only__feature--report action-1-medium-grey">
              신고하기
            </span>
          </a>
        </div>
        <div class="communicate-box-only__input-reviews">
          <input
            type="text"
            (keypress)="commentTyping($event, f)"
            value=""
            #f
            placeholder="댓글 달기">
        </div>
      </div>
    </div>

    <button class="communicate-box__prev-button"
            *ngIf="(data.results ? data.results[0] : '') != reviewsId"
            (click)="prevButton(data.results[currentReviewIndex - 1])">
      <svg width="15" height="26" viewBox="0 0 15 26">
        <path fill="none" fill-rule="evenodd" stroke="#E5E5E5" stroke-width="2" d="M14 1L2 13.098 14 25"/>
      </svg>
    </button>

    <button
      *ngIf="(data.results ? data.results[data.results?.length - 1] : '') != reviewsId"
      class="communicate-box__next-button"
            (click)="nextButton(data.results[currentReviewIndex + 1])">
      <svg width="15" height="26" viewBox="0 0 15 26">
        <path fill="none" fill-rule="evenodd" stroke="#E5E5E5" stroke-width="2" d="M1 25l12-12.098L1 1"/>
      </svg>
    </button>
</div>
</ng-container>
<div class="communicate-box__outer">

</div>

